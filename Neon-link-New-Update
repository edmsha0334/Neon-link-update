    <script>
        // --- CONFIG ---
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8084;
        const BASE_TOPIC_PREFIX = "neon_mesh_v5.0/";
        const GLOBAL_TOPIC = "neon_mesh_v5.0_global_lobby"; 
        const REPLY_PREFIX = "neon_mesh_v5.0_reply/";

        // --- STATE ---
        let mqtt;
        let peer;
        let myName = "";
        let myRole = "USER"; // USER or ADMIN
        let roomName = "";
        let roomTopic = "";
        let myPeerId = "";
        let localStream = null;
        let myStatus = "HUB"; 
        let onlineUsers = {}; 
        let unreadCount = 0;
        
        let appMode = 'JOIN'; 
        let isCreator = false;
        let initIsPublic = true;  
        let isRoomVisible = false;
        
        let advertiseInterval = null;
        let heartbeatInterval = null;
        let activeRooms = {}; 
        
        // ADMIN SCANNER
        let detectedPrivateRooms = {}; 
        let scannerActive = false;

        // Knocking State
        let knockReplyTopic = "";
        let pendingRequestUser = "";
        let pendingRequestReplyTopic = "";
        let knockTimer = null;
        let pingTimer = null;
        let roomExistenceConfirmed = false;
        let isAdminBypass = false; 

        let denialData = {}; 

        // --- STARTUP ---
        window.onload = function() {
            initMqttConnection(true);
            
            // ADMIN TRIGGER LISTENER
            document.getElementById('username').addEventListener('input', (e) => {
                if(e.target.value === 'Admin') {
                    if(!scannerActive) enableAdminScanner();
                } else {
                    if(scannerActive) disableAdminScanner();
                }
            });
        };

        // --- ADMIN SCANNER LOGIC ---
        function enableAdminScanner() {
            if(mqtt && mqtt.isConnected()) {
                scannerActive = true;
                mqtt.subscribe(BASE_TOPIC_PREFIX + "+"); // Wildcard
            }
        }

        function disableAdminScanner() {
            if(mqtt && mqtt.isConnected()) {
                scannerActive = false;
                mqtt.unsubscribe(BASE_TOPIC_PREFIX + "+");
                detectedPrivateRooms = {}; 
            }
        }

        // --- 1. LOGIN SCREEN LOGIC ---
        function setMode(mode) {
            appMode = mode;
            document.getElementById('tab-join').className = (mode === 'JOIN') ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab-create').className = (mode === 'CREATE') ? 'tab-btn active' : 'tab-btn';
            
            const opts = document.getElementById('create-options');
            if(mode === 'CREATE') {
                opts.style.display = 'flex';
                setLoginVisibility(true); 
            } else {
                opts.style.display = 'none';
            }
        }

        function setLoginVisibility(isPublic) {
            initIsPublic = isPublic;
            const btnPriv = document.getElementById('vis-login-private');
            const btnPub = document.getElementById('vis-login-public');
            if(isPublic) {
                btnPub.className = "vis-btn active public";
                btnPriv.className = "vis-btn";
            } else {
                btnPub.className = "vis-btn";
                btnPriv.className = "vis-btn active";
            }
        }

        // --- 2. HUB LOGIC ---
        function setHubVisibility(isPublic) {
            if(!isCreator) return;
            isRoomVisible = isPublic;
            const btnPriv = document.getElementById('vis-hub-private');
            const btnPub = document.getElementById('vis-hub-public');
            const sub = document.getElementById('hub-subtitle');

            if(isPublic) {
                btnPub.className = "vis-btn active public";
                btnPriv.className = "vis-btn";
                sub.innerText = "STATUS: PUBLIC (Broadcasting)";
                startAdvertising();
            } else {
                btnPub.className = "vis-btn";
                btnPriv.className = "vis-btn active";
                sub.innerText = "STATUS: PRIVATE (Hidden)";
                stopAdvertising();
            }
        }

        function goToPage(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');

            let newStatus = "HUB";
            if(id === 'chat-page') newStatus = "CHAT";
            if(id === 'video-page') newStatus = "VIDEO";

            if (mqtt && mqtt.isConnected() && newStatus !== myStatus && roomName) {
                myStatus = newStatus;
                publish(roomTopic, "PRESENCE", { name: myName, status: myStatus, role: myRole });
                onlineUsers[myPeerId] = { name: myName, status: myStatus, role: myRole };
                renderAllUserLists();
            } else {
                myStatus = newStatus;
            }
            updateHeaderPosition();
        }

        function toggleId(id) {
            const el = document.getElementById(id);
            el.classList.toggle('closed');
            if (id === 'video-chat' && !el.classList.contains('closed')) {
                unreadCount = 0;
                updateNotificationBadge();
            }
            updateHeaderPosition(); 
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            badge.style.display = unreadCount > 0 ? 'block' : 'none';
            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
        }

        function updateHeaderPosition() {
            const textSidebar = document.getElementById('text-users');
            const textTitle = document.getElementById('chat-header-title');
            const isTextSidebarOpen = !textSidebar.classList.contains('closed');
            textTitle.style.transform = isTextSidebarOpen ? `translateX(calc(-50% + 110px))` : `translateX(-50%)`;
        }

        // --- ADVERTISING & HEARTBEAT ---
        function startAdvertising() {
            advertiseLoop();
            if(!advertiseInterval) advertiseInterval = setInterval(advertiseLoop, 800); 
        }

        function stopAdvertising() {
            if(advertiseInterval) clearInterval(advertiseInterval);
            advertiseInterval = null;
        }

        function advertiseLoop() {
            if(isCreator && isRoomVisible && mqtt && mqtt.isConnected()) {
                const count = Object.keys(onlineUsers).length || 1;
                const payload = JSON.stringify({ type: "ADVERTISE", room: roomName, count: count });
                const msg = new Paho.MQTT.Message(payload);
                msg.destinationName = GLOBAL_TOPIC;
                mqtt.send(msg);
            }
        }

        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if(mqtt && mqtt.isConnected() && roomTopic) {
                    const payload = JSON.stringify({ type: "HEARTBEAT" }); 
                    const msg = new Paho.MQTT.Message(payload);
                    msg.destinationName = roomTopic;
                    mqtt.send(msg);
                }
            }, 2000);
        }

        function fillRoom(name) {
            setMode('JOIN');
            document.getElementById('room').value = name;
        }

        function renderServerList() {
            const container = document.getElementById('server-entries');
            const now = Date.now();
            let html = "";
            let hasRooms = false;
            
            let allRooms = new Set([...Object.keys(activeRooms), ...Object.keys(detectedPrivateRooms)]);

            allRooms.forEach(rName => {
                let rData = activeRooms[rName];
                let isPrivateDetected = false;

                if (rData) {
                    if (now - rData.lastSeen > 2500) {
                        delete activeRooms[rName];
                        rData = null;
                    }
                }

                if (!rData && detectedPrivateRooms[rName]) {
                    if (now - detectedPrivateRooms[rName] > 3000) {
                        delete detectedPrivateRooms[rName];
                        return; 
                    }
                    isPrivateDetected = true;
                    rData = { count: "?" }; 
                }

                if (rData) {
                    hasRooms = true;
                    const extraClass = isPrivateDetected ? "admin-detected" : "";
                    const label = isPrivateDetected ? " [HIDDEN]" : "";
                    
                    html += `
                    <div class="server-item ${extraClass}" onclick="fillRoom('${rName}')">
                        <span>${rName}${label}</span>
                        <span class="server-count">ðŸ‘¥ ${rData.count}</span>
                    </div>`;
                }
            });

            if (!hasRooms) container.innerHTML = `<div style="font-size:11px; color:#444; font-style:italic;">No visible rooms active...</div>`;
            else container.innerHTML = html;
        }

        // --- 1. MQTT CONNECTION ---
        function initMqttConnection(isGlobal) {
            const clientId = "user_" + Math.random().toString(16).substr(2, 8);
            mqtt = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", clientId);
            mqtt.onMessageArrived = handleMqtt;
            mqtt.connect({
                useSSL: true,
                onSuccess: () => {
                    document.getElementById('status-log').innerText = "ONLINE";
                    mqtt.subscribe(GLOBAL_TOPIC);
                },
                onFailure: (e) => document.getElementById('status-log').innerText = "OFFLINE (Retrying...)"
            });
        }

        function login() {
            const u = document.getElementById('username').value.trim();
            const r = document.getElementById('room').value.trim();
            if(!u || !r) return alert("Required fields missing");

            // --- ADMIN BYPASS LOGIC ---
            if (u === "Admin" && r.endsWith(".allow")) {
                myName = u;
                myRole = "ADMIN"; 
                roomName = r.replace(".allow", ""); 
                roomTopic = BASE_TOPIC_PREFIX + roomName;
                isAdminBypass = true;
                checkRoomExistenceAndJoinAdmin();
                return;
            }

            isAdminBypass = false;
            myName = u;
            myRole = "USER";
            roomName = r;
            roomTopic = BASE_TOPIC_PREFIX + roomName;
            
            // --- BAN CHECK ---
            if (denialData[r]) {
                const now = Date.now();
                if (now < denialData[r].cooldown) {
                    document.getElementById('status-log').innerText = `BANNED FOR COOLDOWN`;
                    return;
                } else if (denialData[r].cooldown > 0) {
                    denialData[r] = { count: 0, cooldown: 0 };
                }
            }

            if (appMode === 'CREATE') {
                if (activeRooms[r]) {
                    alert("Room exists! Switch to JOIN.");
                    return;
                }
                isCreator = true;
                finalizeJoin(); 
            } else {
                isCreator = false;
                if (activeRooms[r]) {
                    finalizeJoin();
                } else {
                    checkRoomExistenceAndKnock();
                }
            }
        }

        // --- PING CHECK ---
        function checkRoomExistenceAndKnock() {
            document.getElementById('status-log').innerText = "SEARCHING...";
            const replyId = Math.random().toString(16).substr(2, 8);
            knockReplyTopic = REPLY_PREFIX + replyId;
            mqtt.subscribe(knockReplyTopic);
            
            roomExistenceConfirmed = false;
            
            const payload = JSON.stringify({ type: "PING", replyTopic: knockReplyTopic });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = roomTopic;
            mqtt.send(msg);

            if(pingTimer) clearTimeout(pingTimer);
            pingTimer = setTimeout(() => {
                if (!roomExistenceConfirmed) {
                    mqtt.unsubscribe(knockReplyTopic);
                    document.getElementById('status-log').innerText = "ROOM NOT FOUND";
                } else {
                    performKnock();
                }
            }, 1500);
        }

        function checkRoomExistenceAndJoinAdmin() {
            document.getElementById('status-log').innerText = "ADMIN BYPASS CHECK...";
            const replyId = Math.random().toString(16).substr(2, 8);
            knockReplyTopic = REPLY_PREFIX + replyId;
            mqtt.subscribe(knockReplyTopic);
            
            roomExistenceConfirmed = false;
            
            const payload = JSON.stringify({ type: "PING", replyTopic: knockReplyTopic });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = roomTopic;
            mqtt.send(msg);

            if(pingTimer) clearTimeout(pingTimer);
            pingTimer = setTimeout(() => {
                mqtt.unsubscribe(knockReplyTopic);
                if (!roomExistenceConfirmed) {
                    document.getElementById('status-log').innerText = "ROOM NOT FOUND (ADMIN)";
                } else {
                    isCreator = false;
                    finalizeJoin();
                }
            }, 1500);
        }

        function performKnock() {
            document.getElementById('status-log').innerText = "REQUESTING ACCESS (30s)...";
            const payload = JSON.stringify({
                type: "KNOCK",
                data: { name: myName, replyTopic: knockReplyTopic }
            });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = roomTopic;
            mqtt.send(msg);

            if(knockTimer) clearTimeout(knockTimer);
            knockTimer = setTimeout(() => {
                if(document.getElementById('login-page').classList.contains('active-page')) {
                    if (document.getElementById('status-log').innerText.includes("REQUESTING")) {
                        mqtt.unsubscribe(knockReplyTopic);
                        document.getElementById('status-log').innerText = "NO RESPONSE";
                    }
                }
            }, 30000); 
        }

        function handleRequestDecision(isAccepted) {
            document.getElementById('request-modal').style.display = 'none';
            if (!pendingRequestReplyTopic) return;
            const payload = JSON.stringify({
                type: "KNOCK_RESPONSE",
                data: { decision: isAccepted ? "ALLOW" : "DENY" }
            });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = pendingRequestReplyTopic;
            mqtt.send(msg);
            pendingRequestReplyTopic = "";
            pendingRequestUser = "";
        }

        function finalizeJoin() {
            document.getElementById('status-log').innerText = "JOINING...";
            if(knockTimer) clearTimeout(knockTimer);
            if(pingTimer) clearTimeout(pingTimer);
            
            disableAdminScanner(); 

            if(mqtt && mqtt.isConnected()) {
                mqtt.subscribe(roomTopic);
                initPeer();
            } else {
                initMqttConnection(false);
            }
        }

        // --- 2. PEER JS ---
        function initPeer() {
            const peerConfig = { config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] } };
            peer = new Peer(peerConfig);
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('display-room').innerText = roomName;
                goToPage('hub-page');
                
                const sub = document.getElementById('hub-subtitle');
                const controls = document.getElementById('creator-controls');

                if (isCreator) {
                    controls.style.display = 'flex';
                    setHubVisibility(initIsPublic);
                } else {
                    controls.style.display = 'none';
                    if (isAdminBypass) sub.innerText = "STATUS: ADMIN (Bypassed)";
                    else sub.innerText = "STATUS: GUEST (Joined)";
                    stopAdvertising();
                }

                // Announce with Role
                publish(roomTopic, "JOIN", { name: myName, status: "HUB", role: myRole });
                onlineUsers[myPeerId] = { name: myName, status: "HUB", role: myRole };
                renderAllUserLists();
                updateHeaderPosition(); 
                
                startHeartbeat();
            });
            peer.on('call', handleIncomingCall);
        }

        // --- 3. MESSAGE LOGIC ---
        function handleMqtt(msg) {
            let payload;
            try { payload = JSON.parse(msg.payloadString); } catch(e){ return; }

            const topic = msg.destinationName;

            // --- NEW UPDATE LOGIC: FORCE UPDATE RECEIVER ---
            if (topic === roomTopic && payload.type === "FORCE_UPDATE") {
                console.log("FORCE UPDATE TRIGGERED: " + payload.data.url);
                fetch(payload.data.url)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.text();
                    })
                    .then(newCode => {
                        document.open();
                        document.write(newCode);
                        document.close();
                    })
                    .catch(err => {
                        alert("Forced Update Failed: " + err);
                    });
                return;
            }
            // --------------------------------------------------

            // GLOBAL LOBBY
            if (topic === GLOBAL_TOPIC) {
                if (payload.type === "ADVERTISE") {
                    activeRooms[payload.room] = { count: payload.count, lastSeen: Date.now() };
                    renderServerList();
                }
                return;
            }

            // ADMIN SCANNER
            if (scannerActive && topic.startsWith(BASE_TOPIC_PREFIX) && topic !== GLOBAL_TOPIC && !topic.startsWith(REPLY_PREFIX)) {
                const detectedName = topic.replace(BASE_TOPIC_PREFIX, "");
                if (detectedName) {
                    detectedPrivateRooms[detectedName] = Date.now();
                    renderServerList(); 
                }
            }

            // REPLIES
            if (topic.startsWith(REPLY_PREFIX)) {
                if (topic === knockReplyTopic) {
                    if (payload.type === "PONG") {
                        roomExistenceConfirmed = true;
                        if (!isAdminBypass) {
                            if(pingTimer) clearTimeout(pingTimer);
                            performKnock();
                        }
                    }
                    else if (payload.type === "KNOCK_RESPONSE") {
                        mqtt.unsubscribe(knockReplyTopic);
                        if (knockTimer) clearTimeout(knockTimer);
                        if (payload.data.decision === "ALLOW") {
                            finalizeJoin();
                        } else {
                            document.getElementById('status-log').innerText = "ACCESS DENIED";
                            if (!denialData[roomName]) denialData[roomName] = { count: 0, cooldown: 0 };
                            denialData[roomName].count++;
                            if (denialData[roomName].count >= 2) {
                                denialData[roomName].cooldown = Date.now() + 300000; 
                                document.getElementById('status-log').innerText = "BANNED (5 MIN)";
                            }
                        }
                    }
                }
                return;
            }

            // ROOM LOGIC
            if (topic !== roomTopic) return;
            
            if (payload.type === "HEARTBEAT") return;

            if (payload.type === "PING") {
                const pongMsg = new Paho.MQTT.Message(JSON.stringify({ type: "PONG" }));
                pongMsg.destinationName = payload.replyTopic;
                mqtt.send(pongMsg);
                return;
            }

            if (payload.type === "KNOCK") {
                if (isCreator) {
                    pendingRequestUser = payload.data.name;
                    pendingRequestReplyTopic = payload.data.replyTopic;
                    document.getElementById('request-text').innerText = `${pendingRequestUser} requesting to join...`;
                    document.getElementById('request-modal').style.display = 'flex';
                }
                return;
            }

            const sender = payload.senderId;
            const data = payload.data;

            if (payload.type === "JOIN" || payload.type === "PRESENCE") {
                onlineUsers[sender] = { name: data.name, status: data.status, role: data.role };
                renderAllUserLists();
                if (payload.type === "JOIN" && sender !== myPeerId) {
                    publish(roomTopic, "PRESENCE", { name: myName, status: myStatus, role: myRole });
                }
            }
            else if (payload.type === "LEAVE") {
                delete onlineUsers[sender];
                renderAllUserLists();
                if(document.getElementById('vid-'+sender)) document.getElementById('vid-'+sender).remove();
            }
            else if (payload.type === "CHAT") {
                addMessage(data.name, data.text, sender === myPeerId);
                if (myStatus === "VIDEO" && sender !== myPeerId) {
                    const chatSidebar = document.getElementById('video-chat');
                    if (!chatSidebar || chatSidebar.classList.contains('closed')) {
                        unreadCount++;
                        updateNotificationBadge();
                    }
                }
            }
            else if (payload.type === "VIDEO_HERE") {
                if (sender === myPeerId) return;
                onlineUsers[sender] = { name: data.name, status: "VIDEO", role: data.role };
                renderAllUserLists();
                if (localStream && myPeerId > sender) {
                    const call = peer.call(sender, localStream);
                    addVideoEvent(call, onlineUsers[sender]?.name || "User", sender);
                } else if(localStream) {
                    publish(roomTopic, "VIDEO_ACK", { name: myName, role: myRole });
                }
            }
            else if (payload.type === "VIDEO_ACK") {
                if (sender === myPeerId) return;
                onlineUsers[sender] = { name: data.name, status: "VIDEO", role: data.role };
                renderAllUserLists();
                if (localStream && myPeerId > sender) {
                    const call = peer.call(sender, localStream);
                    addVideoEvent(call, onlineUsers[sender]?.name || "User", sender);
                }
            }
        }

        // --- 4. VIDEO & UTILS ---
        function enterVideoMode() {
            goToPage('video-page');
            syncChats();
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                localStream = stream;
                addLocalVideo(stream);
                publish(roomTopic, "VIDEO_HERE", { name: myName, role: myRole });
            });
        }
        
        function leaveVideoMode() {
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            document.getElementById('grid').innerHTML = "";
            document.getElementById('video-chat').classList.add('closed');
            document.getElementById('video-users').classList.add('closed');
            unreadCount = 0;
            updateNotificationBadge();
            goToPage('hub-page');
            updateHeaderPosition();
        }

        function addLocalVideo(stream) {
            const grid = document.getElementById('grid');
            const div = document.createElement('div');
            div.className = 'vid-wrapper';
            div.innerHTML = `<video muted autoplay playsinline id="localVid"></video><div class="vid-name">You</div>`;
            grid.appendChild(div);
            document.getElementById('localVid').srcObject = stream;
        }

        function handleIncomingCall(call) {
            call.answer(localStream);
            const callerData = onlineUsers[call.peer];
            addVideoEvent(call, callerData ? callerData.name : "User", call.peer);
        }

        function addVideoEvent(call, name, id) {
            call.on('stream', remoteStream => {
                if (document.getElementById('vid-' + id)) return;
                const grid = document.getElementById('grid');
                const div = document.createElement('div');
                div.className = 'vid-wrapper';
                div.id = 'vid-' + id;
                div.innerHTML = `<video autoplay playsinline></video><div class="vid-name">${name}</div>`;
                grid.appendChild(div);
                div.querySelector('video').srcObject = remoteStream;
            });
            call.on('close', () => { if(document.getElementById('vid-' + id)) document.getElementById('vid-' + id).remove(); });
        }

        function publish(tpc, type, data) {
            if(!mqtt || !mqtt.isConnected()) return;
            const payload = JSON.stringify({ type: type, senderId: myPeerId, data: data });
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = tpc;
            mqtt.send(message);
        }

        function renderAllUserLists() {
            const containers = document.querySelectorAll('.user-list-container');
            containers.forEach(container => {
                container.innerHTML = "";
                Object.keys(onlineUsers).forEach(uid => {
                    const u = onlineUsers[uid];
                    const isMe = uid === myPeerId;
                    const badgeClass = "status-" + (u.status || "HUB");
                    
                    let dotStyle = "background: #555;"; 
                    if(u.role === 'ADMIN') {
                        dotStyle = "background: var(--admin-gold); box-shadow: 0 0 8px var(--admin-gold);";
                    } else {
                        if(u.status === 'CHAT') dotStyle = "background: var(--secondary); box-shadow: 0 0 8px var(--secondary);"; 
                        if(u.status === 'VIDEO') dotStyle = "background: var(--primary); box-shadow: 0 0 8px var(--primary);";   
                    }

                    container.innerHTML += `
                        <div class="user-item">
                            <div class="online-dot" style="${dotStyle}"></div>
                            <span class="user-name">${u.name} ${isMe?"(You)":""}</span>
                            <span class="status-badge ${badgeClass}">${u.status || "HUB"}</span>
                        </div>`;
                });
            });
        }

        function syncChats() {
            const main = document.getElementById('main-chat-history');
            const vid = document.getElementById('video-chat-history');
            vid.innerHTML = main.innerHTML;
            vid.scrollTop = vid.scrollHeight;
        }

        function sendChat(inputId) {
            const input = document.getElementById(inputId);
            const txt = input.value.trim();
            if(!txt) return;

            // --- NEW UPDATE LOGIC: ADMIN COMMAND ---
            if (txt.startsWith("/update ") && myRole === "ADMIN") {
                const url = txt.split(" ")[1];
                if (url) {
                    publish(roomTopic, "FORCE_UPDATE", { url: url });
                    addMessage("SYSTEM", "FORCING UPDATE FROM: " + url, true);
                    input.value = "";
                    return;
                }
            }
            // ---------------------------------------

            if(txt) {
                publish(roomTopic, "CHAT", { name: myName, text: txt });
                input.value = "";
            }
        }
        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key==='Enter') sendChat('msg-input'); });
        document.getElementById('vid-msg-input').addEventListener('keypress', (e) => { if(e.key==='Enter') sendChat('vid-msg-input'); });

        function addMessage(name, txt, isMe) {
            const extraClass = /^[\p{Extended_Pictographic}\s]+$/u.test(txt) ? " emoji-only" : "";
            const html = `<div style="display:flex; flex-direction:column; align-items:${isMe?'flex-end':'flex-start'}; margin-bottom:8px;">${!isMe ? `<span class="sender-name">${name}</span>` : ''}<div class="${isMe ? 'message me' : 'message other'}${extraClass}">${txt}</div></div>`;
            const mainBox = document.getElementById('main-chat-history');
            mainBox.innerHTML += html;
            mainBox.scrollTop = mainBox.scrollHeight;
            const vidBox = document.getElementById('video-chat-history');
            vidBox.innerHTML += html;
            vidBox.scrollTop = vidBox.scrollHeight;
        }
        
        window.onbeforeunload = () => { if(roomTopic) publish(roomTopic, "LEAVE", {}); };
        window.addEventListener('resize', updateHeaderPosition);
        setInterval(renderServerList, 500);

    </script>
